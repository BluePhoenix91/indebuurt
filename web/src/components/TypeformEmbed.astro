---
interface Props {
  typeformId: string;
  className?: string;
  initialHeight?: number; // Initial height in pixels (default: 400px)
}

const { typeformId, className = "", initialHeight = 400 } = Astro.props;
---

<div class={`typeform-container ${className}`}>
  <div
    class="typeform-wrapper"
    data-tf-live={typeformId}
    data-tf-opacity="100"
    data-tf-iframe-props={`title=Feedback form`}
    data-tf-transitive-search-params
    data-tf-medium="snippet"
    aria-label="Feedback form"
    style={`min-height: ${initialHeight}px;`}
  >
  </div>
</div>

<style>
  .typeform-container {
    width: 100%;
    position: relative;
    contain: layout style paint;
  }

  .typeform-wrapper {
    width: 100%;
    display: block;
    /* Let Typeform handle the actual height - it will auto-resize */
    /* We only set min-height to prevent layout shift */
  }
</style>

<script define:vars={{ typeformId, initialHeight }}>
  // Lazy load Typeform script when container enters viewport
  document.addEventListener("DOMContentLoaded", function () {
    const container = document
      .querySelector(`[data-tf-live="${typeformId}"]`)
      ?.closest(".typeform-container");
    if (!container) return;

    const wrapper = container.querySelector(".typeform-wrapper");
    if (!wrapper) return;

    // Check if script already loaded
    if (document.querySelector('script[src*="embed.typeform.com"]')) {
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Load Typeform script
            const script = document.createElement("script");
            script.src = "https://embed.typeform.com/next/embed.js";
            script.async = true;
            script.onload = () => {
              // Track GA4 event when Typeform loads
              if (typeof window !== "undefined" && window.gtag) {
                window.gtag("event", "typeform_loaded", {
                  event_category: "engagement",
                  event_label: "contribution_form",
                });
              }

              // Typeform will auto-resize, but we can remove min-height constraint
              // after a short delay to let it settle
              setTimeout(() => {
                wrapper.style.minHeight = "auto";
              }, 1000);
            };
            document.body.appendChild(script);
            observer.disconnect();
          }
        });
      },
      {
        rootMargin: "200px",
      }
    );

    observer.observe(container);
  });
</script>
