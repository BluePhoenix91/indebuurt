---
interface Props {
  typeformId: string;
  className?: string;
}

const { typeformId, className = "" } = Astro.props;
---

<div class={`typeform-container ${className}`}>
  <div
    class="typeform-wrapper"
    data-tf-live={typeformId}
    data-tf-opacity="100"
    data-tf-iframe-props={`title=Feedback form`}
    data-tf-transitive-search-params
    data-tf-medium="snippet"
    aria-label="Feedback form"
  >
  </div>
</div>

<style>
  .typeform-container {
    width: 100%;
    min-height: 600px;
    position: relative;
    contain: layout style paint;
  }

  .typeform-wrapper {
    width: 100%;
    height: 600px;
    min-height: 600px;
    display: block;
  }
</style>

<script define:vars={{ typeformId }}>
  // Lazy load Typeform script when container enters viewport
  document.addEventListener("DOMContentLoaded", function () {
    const container = document
      .querySelector(`[data-tf-live="${typeformId}"]`)
      ?.closest(".typeform-container");
    if (!container) return;

    // Check if script already loaded
    if (document.querySelector('script[src*="embed.typeform.com"]')) {
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Load Typeform script
            const script = document.createElement("script");
            script.src = "https://embed.typeform.com/next/embed.js";
            script.async = true;
            script.onload = () => {
              // Track GA4 event when Typeform loads
              if (typeof window !== "undefined" && window.gtag) {
                window.gtag("event", "typeform_loaded", {
                  event_category: "engagement",
                  event_label: "contribution_form",
                });
              }
            };
            document.body.appendChild(script);
            observer.disconnect();
          }
        });
      },
      {
        rootMargin: "200px",
      }
    );

    observer.observe(container);
  });
</script>
